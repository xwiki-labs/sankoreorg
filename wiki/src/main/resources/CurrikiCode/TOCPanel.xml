<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>CurrikiCode</web>
  <name>TOCPanel</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>CurrikiCode.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1228764010000</creationDate>
  <date>1419607083000</date>
  <contentUpdateDate>1419607083000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/1.0</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>Panels.PanelClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <category>
        <cache>0</cache>
        <customDisplay/>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>category</name>
        <number>5</number>
        <picker>0</picker>
        <prettyName>Category</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <sort>none</sort>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <values>Information|Navigation|Tools|Administration|Other</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </category>
      <content>
        <customDisplay/>
        <disabled>0</disabled>
        <editor>---</editor>
        <name>content</name>
        <number>4</number>
        <picker>0</picker>
        <prettyName>Content</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </content>
      <description>
        <customDisplay/>
        <disabled>0</disabled>
        <editor>---</editor>
        <name>description</name>
        <number>3</number>
        <picker>0</picker>
        <prettyName>Description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <name>
        <customDisplay/>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <picker>0</picker>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <cache>0</cache>
        <customDisplay/>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>type</name>
        <number>2</number>
        <picker>0</picker>
        <prettyName>Panel type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <sort>none</sort>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <values>view|edit</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </type>
    </class>
    <name>CurrikiCode.TOCPanel</name>
    <number>0</number>
    <className>Panels.PanelClass</className>
    <guid>75d76487-6d0f-4d33-9e5f-b741594956a2</guid>
    <property>
      <category>Tools</category>
    </property>
    <property>
      <content>#if($doc.space.startsWith("Coll_") &amp;&amp; $doc.hasAccessLevel("view") &amp;&amp; !$doc.isNew()) ## {
{pre}
#macro(tocAssetSubtype $assetDoc)
  ###set($rClass = $subAsset.getAssetClass().getSimpleName().replaceAll("Asset$", ""))
  #set($rType = $assetDoc.getAssetClass().name.replaceAll("^.*\056", "").replaceAll("Asset$", ""))
  #if("$!rType" == "")
    #set($rType = "Unknown")
  #end
#end
##
#macro(tocToJSON $curDoc $lastAssetName $lastAssetJSON)
  ## set Current asset information
  #set($curTitle = $curDoc.getDisplayTitle().replaceAll('\\', '\\\\').replaceAll("'", "\\'"))
  #set($curDesc = $curDoc.getDescription().replaceAll('\\', '\\\\').replace("'", "&amp;#39;").replaceAll("[\n|\r]+", "&lt;br /&gt;"))
  #set($curHref = $xwiki.getURL($curDoc.fullName, 'view'))
  #set($curSelected = "")
  #if($curDoc.fullName == $doc.fullName)
    #set($curSelected = " toc-selected")
  #end
  #tocAssetSubtype($curDoc)
  #set($curType = $rType)
  ## Get Framework items
  #set($curFW = "")
  #set($subj = $!curDoc.getValue('fw_items'))
  #set($isFirst = true)
  #foreach($item in $subj)    
    #if($isFirst)
      #set($isFirst = false)
    #else
      #set($curFW = "$curFW, ")
    #end
    #set($curFW = "$curFW'$item'")  
  #end
  #set($curFW = "[ $curFW ]")
  ## Get educational levels
  #set($curLvl = "")
  #set($levl = $!curDoc.getValue('educational_level'))
  #set($isFirst = true)
  #foreach($item in $levl)
  #if($isFirst)
      #set($isFirst = false)
    #else
      #set($curLvl = "$curLvl, ")
    #end
    #set($curLvl = "$curLvl'$item'")
  #end
  #set($curLvl = "[ $curLvl ]")
  ## Get icts
  #set($curICT = "")
  #set($ict = $!curDoc.getValue('instructional_component'))
  #set($isFirst = true)
  #foreach($item in $ict)
    #if($isFirst)
      #set($isFirst = false)
    #else
      #set($curICT = "$curICT, ")
    #end
  #set($curICT = "$curICT'$item'")
  #end
  #set($curICT = "[ $curICT ]")
  #set($curLicense = $curDoc.getObject("CurrikiCode.AssetLicenseClass").get("licenseType"))
  ##
  ## Create json
  #if($curDoc.isFolder())
    ## Current item is a composite -- so need to get children
    #set($curSubJSON = "")
    #set($curSublist = $curDoc.getSubassetList())
    #foreach($subItem in $curSublist)
      #if($subItem == $lastAssetName)
        #set($curSubJSON = "$curSubJSON,$lastAssetJSON")
      #else
        #set($subAsset = $!xwiki.curriki.fetchAssetOrNull($subItem))
        #if($subAsset)
          #tocAssetSubtype($subAsset)
          #set($subTitle = $subAsset.getDisplayTitle().replaceAll('\\', '\\\\').replaceAll("'", "\\'"))
          #set($subDesc = $subAsset.getDescription().replaceAll('\\', '\\\\').replace("'", "&amp;#39;").replaceAll("[\n|\r]+", "&lt;br /&gt;"))
          #set($subHref = $xwiki.getURL($subAsset.fullName, 'view'))
          ## Get Framework items
          #set($subFW = "")
          #set($subj = $!subAsset.getValue('fw_items'))
          #set($isFirst = true)
          #foreach($item in $subj)
            #if($isFirst)
              #set($isFirst = false)
            #else
              #set($subFW = "$subFW, ")
            #end
            #set($subFW = "$subFW'$item'")
          #end
          #set($subFW = "[ $subFW ]")
          ## Get educational levels
          #set($subLvl = "")
          #set($levl = $!subAsset.getValue('educational_level'))
          #set($isFirst = true)
          #foreach($item in $levl)
            #if($isFirst)
              #set($isFirst = false)
            #else
              #set($subLvl = "$subLvl, ")
            #end
            #set($subLvl = "$subLvl'$item'")
          #end
          #set($subLvl = "[ $subLvl ]")
          ## Get icts
          #set($subICT = "")
          #set($ict = $!subAsset.getValue('instructional_component'))
          #set($isFirst = true)
          #foreach($item in $ict)
            #if($isFirst)
              #set($isFirst = false)
            #else
              #set($subICT = "$subICT, ")
            #end
            #set($subICT = "$subICT'$item'")
          #end
          #set($subICT = "[ $subICT ]")
          ##
          #set($subSubCategory = "")
          #set($subSubCategory = $subAsset.categorySubtype)
          #if("$!subSubCategory" == "")
            #set($subSubCategory = "unknown")
          #end
          #set($subLicense = $subAsset.getValue("licenseType"))
          ##
          #if($subAsset.isFolder())
            #set($curSubJSON = "$curSubJSON,{collectionPage:'$!{subAsset.fullName}', displayTitle: '$!{subTitle}', description:'$!{subDesc}', fwItems:$!{subFW}, levels:$!subLvl, ict:$!subICT, license:'$!subLicense', assetType:'$!{rType}', category:'$!{subAsset.category}', subcategory:'$!{subSubCategory}', href:'$!{subHref}', leaf:false}")
          #else ## Not isFolder()
            #set($curSubJSON = "$curSubJSON,{assetpage:'$!{subAsset.fullName}', displayTitle: '$!{subTitle}', description:'$!{subDesc}', fwItems:$!{subFW}, levels:$!subLvl, ict:$!subICT, license:'$!{curLicense}', assetType:'$!{rType}', category:'$!{subAsset.category}', subcategory:'$!{subSubCategory}', href:'$!{subHref}', leaf:true}")
          #end
        #end
      #end
    #end
    #set($curSubJSON = $curSubJSON.replaceAll("^,", ""))
    ##
    #set($curSubCategory = "")
    #set($curSubCategory = $curDoc.categorySubtype)
    #if("$!curSubCategory" == "")
      #set($curSubCategory = "unknown")
    #end
    ##
    #set($curJSON = "{collectionPage:'$!{curDoc.fullName}', displayTitle: '$!{curTitle}', description:'$!{curDesc}', fwItems:$!{curFW}, levels:$!curLvl, ict:$!curICT, license:'$!{curLicense}', assetType:'$!{curType}', category:'$!{curDoc.category}', subcategory:'$!{curSubCategory}', addCls:'$!{curSelected}', href:'$!{curHref}', expanded: true, children:[$!{curSubJSON}]}")
  #else ##  Not isFolder()
    #set($curSubCategory = "")
    #set($curSubCategory = $curDoc.categorySubtype)
    #if("$!curSubCategory" == "")
      #set($curSubCategory = "unknown")
    #end
    #set($curJSON = "{assetpage:'$!{curDoc.fullName}', displayTitle: '$!{curTitle}', description:'$!{curDesc}', fwItems:$!{curFW}, levels:$!curLvl, ict:$!curICT, license:'$!{curLicense}', assetType:'$!{curType}', category:'$!{curDoc.category}', subcategory:'$!{curSubCategory}', addCls:'$!{curSelected}', href:'$!{curHref}', leaf: true}")
  #end
#end
## End macro

## Reverse breadcrumb (we need to work bottom to top)
#set($bc = "")
#set($emptyBC = false)
#foreach($bcItem in $request.bc.split(";"))
  #if($bcItem.startsWith('Coll_') &amp;&amp; !$bcItem.endsWith('.WebHome') &amp;&amp; $bcItem != "${doc.fullName}")
    #set($bc = "$bcItem;$bc")
  #end
#end
#set($bc = $bc.replaceAll(";$", ""))
#if($bc == "")
  #set($emptyBC = true)
#end
#set($bc = "${doc.fullName};$bc")

#set($lastAssetName = "X")
#set($lastAssetJSON = "")
#set($lastAssetIsCollection = false)

#foreach($bcItem in $bc.split(";"))
  #set($curDoc = $xwiki.curriki.fetchAssetOrNull($bcItem))
  #if($curDoc)
    #tocToJSON($curDoc $lastAssetName $lastAssetJSON)
    #set($lastAssetName = $curDoc.fullName)
    #set($lastAssetJSON = $curJSON)
    #set($lastAssetIsCollection = $curDoc.isCollection())
  #end
#end

#if($emptyBC)
  ## Here we need to see if there are any more parents we can add
  #foreach($i in [1..50]) ## There is no while loop in velocity (nor break)
    #if($lastAssetName != "" &amp;&amp; !$lastAssetIsCollection)
      #set($sql = ", BaseObject as composite, BaseObject as subasset, StringProperty as cprops, StringProperty as sprops where doc.name != 'Favorites' and doc.name != 'WebHome' and composite.name=doc.fullName and composite.className='CurrikiCode.CompositeAssetClass' and composite.id=cprops.id.id and cprops.id.name='type' and (cprops.value='collection' or cprops.value='curriki_document') and subasset.name=doc.fullName and subasset.id=sprops.id.id and subasset.className='CurrikiCode.SubAssetClass' and sprops.id.name='assetpage' and sprops.value='${lastAssetName}' order by doc.name")
      #set($parentList = $xwiki.searchDocuments($sql))
      #if($parentList.size() == 1)
        #foreach($parentPage in $parentList)
          #set($curDoc = $!xwiki.curriki.fetchAssetOrNull($parentPage))
          #if($curDoc)
            #tocToJSON($curDoc $lastAssetName $lastAssetJSON)
            #set($lastAssetName = $curDoc.fullName)
            #set($lastAssetJSON = $curJSON)
            #set($lastAssetIsCollection = $curDoc.isCollection())
            #set($bc = "$bc;$parentPage")
          #else
            #set($lastAssetName = "")
          #end
        #end
      #else
        #set($lastAssetName = "")
      #end
    #end
  #end
#end
#if("$lastAssetJSON" == "")
  #set($lastAssetJSON = "{}")
#end

&lt;script type="text/javascript"&gt;
/* &lt;![CDATA[ */
Ext.ns('Curriki.data.toc');
Curriki.data.toc.bc = "$bc";
Curriki.data.toc.tocData = $lastAssetJSON;
Curriki.data.toc.selected = "$doc.fullName";
/* ]]&gt; */
&lt;/script&gt;
#if($globalDebug)
  #set($debugging = "-debug")
#else
  #set($debugging = "")
#end
&lt;script src="/xwiki/js/curriki-module-toc${debugging}.js"&gt;&lt;/script&gt;
&lt;div id="resource-toc" class="panel CurrikiCode.TOCPanel extjs"&gt;&lt;/div&gt;
#set($discard = $xwiki.ssx.use('CurrikiCode.TOCSSX', {'minify': false}))
{/pre}
#end</content>
    </property>
    <property>
      <description>Table of Contents Panel for Resources</description>
    </property>
    <property>
      <name>TOCPanel</name>
    </property>
    <property>
      <type>view</type>
    </property>
  </object>
  <content>#includeForm("Panels.PanelSheet")</content>
</xwikidoc>
